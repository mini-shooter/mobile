<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>Mini Shooter ‚Äì BS Controls + Speicher (Fix)</title>
<style>
  html,body{margin:0;height:100%;background:#0e0f12;font-family:system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  #wrap{position:relative;width:100vw;height:100vh}
  canvas{position:absolute;inset:0;display:block;width:100vw;height:100vh;background:linear-gradient(#141925,#0d111a)}

  /* HUD */
  .hud{position:absolute;left:12px;top:12px;color:#fff;z-index:5;user-select:none}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:4px 8px;border-radius:999px;background:#232633;border:1px solid #2d3246;font-size:12px}
  .hearts{display:flex;gap:6px}
  .heart{width:18px;height:18px;background:#ef4444;clip-path:path("M8.8 3.2c.7-1.2 2.7-1.2 3.4 0 .6 1 .4 2.5-.6 3.3L10.5 7 9 6.5c-1-.8-1.2-2.3-.6-3.3z M3 7c0-2.2 1.6-4 3.6-4 1 0 1.9.5 2.5 1.2C9.6 3.5 10.5 3 11.5 3 13.5 3 15 4.8 15 7c0 3.6-6 8-6 8S3 10.6 3 7");opacity:.9}
  .heart.off{background:#475569;opacity:.6}

  /* Game over */
  .center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#fff;text-align:center;z-index:6;display:none}
  .center h1{margin:0 0 8px;font-size:40px}

  /* Shop Overlay */
  .overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:10}
  .shop{width:min(860px,94vw);max-height:86vh;overflow:auto;background:#10151f;border:1px solid #283041;border-radius:16px;color:#fff;padding:14px;position:relative}
  .shop h2{margin:6px 0 10px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .grid.settings{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .card{background:#151b27;border:1px solid #27334a;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
  .badge{font-size:11px;background:#263049;padding:2px 6px;border-radius:999px}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid #3b82f6;background:#1e293b;color:#fff;font-weight:700;cursor:pointer}
  .btn[disabled]{opacity:.55;cursor:not-allowed}
  .closeX{position:absolute;right:12px;top:8px;font-size:22px;cursor:pointer;opacity:.9}
  .small{font-size:12px;opacity:.9}

  /* Mobile controls ‚Äì zwei Sticks */
  .mobile{position:absolute;inset:0;pointer-events:none;z-index:9}
  .stick{position:absolute;width:140px;height:140px;border-radius:50%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);pointer-events:auto;touch-action:none}
  .knob{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:64px;height:64px;border-radius:50%;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.2)}
  #moveStick{left:16px;bottom:16px}
  #shootStick{right:16px;bottom:16px}
  .shopBtn{position:absolute;right:24px;bottom:180px;width:110px;height:46px;border-radius:12px;background:rgba(120,180,255,.15);border:1px solid rgba(120,180,255,.4);pointer-events:auto;color:#fff;font-weight:800;display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>

  <!-- HUD -->
  <div class="hud">
    <div class="row" style="margin-bottom:8px;">
      <div class="pill">Score: <span id="score">0</span></div>
      <div class="pill">Highscore: <span id="best">0</span></div>
      <div class="pill">Waffe: <span id="weaponName">Pistol</span></div>
      <div class="pill">Coins: <span id="coins">0</span></div>
      <div class="pill">Shop: <b>B</b></div>
    </div>
    <div class="row">
      <div class="pill">HP</div>
      <div class="hearts" id="hearts"></div>
    </div>
  </div>

  <!-- Game Over -->
  <div class="center" id="center">
    <h1>Game Over</h1>
    <p>Tippen oder Leertaste: Neustart</p>
  </div>

  <!-- Shop -->
  <div class="overlay" id="overlay">
    <div class="shop">
      <div class="closeX" id="closeShop">‚úï</div>
      <h2>üõí Shop <span class="badge">Coins: <span id="coinsShop">0</span></span> <span class="badge">Highscore: <span id="bestShop">0</span></span></h2>
      <div class="grid settings" id="settingsGrid"></div>
      <div class="grid" id="shopGrid"></div>
      <p class="small">Mobil: linker Stick bewegen, rechter Stick ziehen & loslassen zum Schie√üen, kurzer Tap = Quick Fire. Gegner haben 1 HP.</p>
    </div>
  </div>

  <!-- Mobile controls -->
  <div class="mobile" id="mobile">
    <div class="stick" id="moveStick"><div class="knob"></div></div>
    <div class="stick" id="shootStick"><div class="knob"></div></div>
    <div class="shopBtn" id="shopBtn">SHOP</div>
  </div>
</div>

<script>
(function(){
"use strict";

/* ===== Helpers ===== */
const byId=(id)=>document.getElementById(id);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rand=(a,b)=>Math.random()*(b-a)+a;

/* ===== Canvas ===== */
const canvas=byId('game'), g=canvas.getContext('2d');
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;} addEventListener('resize',resize); resize();

/* ===== Config ===== */
const K={worldW:2200,worldH:1400,playerSpeed:220,bulletSpeed:700,enemySpeed:95,spawnEvery:1.6,coinPerKill:1,playerMaxHP:3,enemyHP:1};
const SAVE_KEY='miniShooterV1';

/* ===== Input (PC) ===== */
const keys=new Set();
addEventListener('keydown',e=>{keys.add(e.code);if(e.code==='KeyB')toggleShop(true);if(e.code==='Space'&&S.over)resetGame();});
addEventListener('keyup',e=>keys.delete(e.code));
const mouse={x:canvas.width/2,y:canvas.height/2,down:false};
canvas.addEventListener('mousemove',e=>{const r=canvas.getBoundingClientRect();mouse.x=e.clientX-r.left;mouse.y=e.clientY-r.top;});
canvas.addEventListener('mousedown',()=>mouse.down=true);
addEventListener('mouseup',()=>mouse.down=false);

/* ===== Mobile BS Controls (2 Sticks) ===== */
const isTouch='ontouchstart' in window||navigator.maxTouchPoints>0;
byId('mobile').style.display=isTouch?'block':'none';

function makeStick(el){
  const knob=el.querySelector('.knob');
  const o={active:false, vec:{x:0,y:0}};
  const max=50;
  function start(x,y){ o.active=true; update(x,y); }
  function update(x,y){
    const r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    let dx=x-cx, dy=y-cy; const len=Math.hypot(dx,dy);
    const cl=Math.min(max,len||1);
    if(len>0){dx=dx/len*cl; dy=dy/len*cl;}
    knob.style.transform=`translate(${dx}px,${dy}px) translate(-50%,-50%)`;
    o.vec.x=dx/max; o.vec.y=dy/max;
  }
  function end(){
    const last={x:o.vec.x,y:o.vec.y};
    o.active=false; o.vec.x=0; o.vec.y=0;
    knob.style.transform='translate(-50%,-50%)';
    if(el.id==='shootStick'){ handleShootRelease(last); }
  }
  el.addEventListener('touchstart',e=>{e.preventDefault();const t=e.changedTouches[0];start(t.clientX,t.clientY)},{passive:false});
  el.addEventListener('touchmove', e=>{e.preventDefault();const t=e.changedTouches[0];update(t.clientX,t.clientY)},{passive:false});
  el.addEventListener('touchend',  e=>{e.preventDefault();end();},{passive:false});
  el.addEventListener('touchcancel',e=>{e.preventDefault();end();},{passive:false});
  return o;
}
const moveStick=makeStick(byId('moveStick'));
const shootStick=makeStick(byId('shootStick'));
byId('shopBtn').addEventListener('touchstart',e=>{e.preventDefault();toggleShop(true)},{passive:false});

/* ===== Shop & Settings ===== */
const WEAPONS=[
  {id:'pistol', name:'Pistol',  price:0,  rate:4, dmg:1, multi:1, spread:0},
  {id:'smg',    name:'SMG',     price:6,  rate:9, dmg:1, multi:1, spread:0.05},
  {id:'shotgun',name:'Shotgun', price:10, rate:2, dmg:1, multi:3, spread:0.18}
];
const getW=id=>WEAPONS.find(w=>w.id===id);

const overlay=byId('overlay'), shopGrid=byId('shopGrid'), coinsShop=byId('coinsShop'), bestShop=byId('bestShop'), settingsGrid=byId('settingsGrid');
byId('closeShop').onclick=()=>toggleShop(false);
overlay.addEventListener('click',e=>{if(e.target===overlay)toggleShop(false);});
function toggleShop(on){ overlay.style.display=on?'flex':'none'; if(on) renderShop(); }

function flashBtn(btn){ const old=btn.textContent; btn.textContent='‚úî'; setTimeout(()=>btn.textContent=old,700); }

function renderShop(){
  coinsShop.textContent=S.coins;
  bestShop.textContent=S.best|0;

  // Speicher-Card
  settingsGrid.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  card.innerHTML=`
    <div><b>‚öôÔ∏è Speicher</b></div>
    <div class="small">Speichert Coins, gekaufte Waffen, aktive Waffe & Highscore lokal.</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="saveBtn">Speichern</button>
      <button class="btn" id="loadBtn">Laden</button>
      <button class="btn" id="resetBtn">Reset Speicher</button>
    </div>`;
  settingsGrid.appendChild(card);
  card.querySelector('#saveBtn').onclick=()=>{ saveGame(); flashBtn(card.querySelector('#saveBtn')); };
  card.querySelector('#loadBtn').onclick=()=>{ loadGame(true); flashBtn(card.querySelector('#loadBtn')); renderShop(); updateHUD(); };
  card.querySelector('#resetBtn').onclick=()=>{ if(confirm('Speicher wirklich l√∂schen?')){ clearSave(); flashBtn(card.querySelector('#resetBtn')); renderShop(); updateHUD(); } };

  // Waffen
  shopGrid.innerHTML='';
  for(const w of WEAPONS){
    const owned=S.owned.has(w.id),active=S.p.weapon===w.id;
    const c=document.createElement('div'); c.className='card';
    c.innerHTML=`<div><b>${w.name}</b> ${owned?(active?'<span class="badge">Aktiv</span>':'<span class="badge">Gekauft</span>'):''}</div>
                 <div class="badge">Preis: ${w.price}c</div>`;
    const btn=document.createElement('button'); btn.className='btn';
    if(!owned){
      btn.textContent='Kaufen'; btn.disabled=S.coins<w.price;
      btn.onclick=()=>{ if(S.coins>=w.price){ S.coins-=w.price; S.owned.add(w.id); updateHUD(); renderShop(); saveGame(); } };
    }else{
      btn.textContent=active?'Aktiv':'Ausr√ºsten';
      btn.onclick=()=>{ S.p.weapon=w.id; updateHUD(); renderShop(); saveGame(); };
    }
    c.appendChild(btn); shopGrid.appendChild(c);
  }
}

/* ===== State + Speicher ===== */
let S;
function newRunBase(){
  return {
    t:0, cam:{x:0,y:0},
    p:{x:K.worldW/2,y:K.worldH/2,hp:K.playerMaxHP,cd:0,weapon:'pistol'},
    bullets:[], enemies:[], score:0, wave:1, nextSpawn:0,
    coins:0, owned:new Set(['pistol']),
    best:0, over:false, hitCD:0
  };
}
function applyMetaFromSave(meta){
  if(!meta) return;
  S.coins = meta.coins ?? S.coins;
  S.best  = meta.best ?? S.best;
  S.p.weapon = meta.weapon ?? S.p.weapon;
  if(Array.isArray(meta.owned)){ S.owned=new Set(meta.owned); if(!S.owned.has('pistol')) S.owned.add('pistol'); }
}
function resetGame(){
  S=newRunBase();
  const meta = loadMeta();
  applyMetaFromSave(meta);
  spawnEnemy(); spawnEnemy();
  updateHUD(); byId('center').style.display='none';
}
function serializeMeta(){ return {version:1, coins:S.coins|0, best:S.best|0, weapon:S.p.weapon, owned:[...S.owned]}; }
function saveGame(){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify(serializeMeta())); }catch(e){} }
function loadMeta(){ try{ const raw=localStorage.getItem(SAVE_KEY); if(!raw) return null; const obj=JSON.parse(raw); return (obj&&typeof obj==='object')?obj:null; }catch(e){ return null; } }
function loadGame(applyNow=false){ const meta=loadMeta(); if(!meta) return false; if(applyNow) applyMetaFromSave(meta); return true; }
function clearSave(){ try{ localStorage.removeItem(SAVE_KEY); }catch(e){} }

resetGame();
let autosaveT=0;
addEventListener('beforeunload', saveGame);

/* ===== Shooting ===== */
function handleShootRelease(vec){
  const mag=Math.hypot(vec.x,vec.y);
  if(mag<0.3){
    // Quick Fire: schie√üt Richtung n√§chster Gegner (nur ein Schuss, kein Tracking)
    let target=null,best=Infinity;
    for(const e of S.enemies){const d=(e.x-S.p.x)**2+(e.y-S.p.y)**2; if(d<best){best=d; target=e;}}
    if(target){ shootAt(target.x,target.y); }
  }else{
    const ang=Math.atan2(vec.y,vec.x);
    shootDir(ang);
  }
}
function shootAt(wx,wy){
  const w=getW(S.p.weapon);
  if(S.p.cd>0) return;
  const ang=Math.atan2(wy-S.p.y,wx-S.p.x);
  for(let i=0;i<w.multi;i++){
    const a=ang+(w.multi>1?(i-(w.multi-1)/2)*w.spread:(Math.random()*2-1)*w.spread);
    S.bullets.push({x:S.p.x,y:S.p.y,vx:Math.cos(a)*K.bulletSpeed,vy:Math.sin(a)*K.bulletSpeed,life:0.9,dmg:w.dmg});
  }
  S.p.cd=1/w.rate;
}
function shootDir(ang){
  const w=getW(S.p.weapon);
  if(S.p.cd>0) return;
  for(let i=0;i<w.multi;i++){
    const a=ang+(w.multi>1?(i-(w.multi-1)/2)*w.spread:(Math.random()*2-1)*w.spread);
    S.bullets.push({x:S.p.x,y:S.p.y,vx:Math.cos(a)*K.bulletSpeed,vy:Math.sin(a)*K.bulletSpeed,life:0.9,dmg:w.dmg});
  }
  S.p.cd=1/w.rate;
}

/* ===== Enemies ===== */
function spawnEnemy(){
  const m=40, side=(Math.random()*4)|0;
  let x,y;
  if(side==0){x=rand(0,K.worldW);y=-m}
  else if(side==1){x=K.worldW+m;y=rand(0,K.worldH)}
  else if(side==2){x=rand(0,K.worldW);y=K.worldH+m}
  else{x=-m;y=rand(0,K.worldH)}
  S.enemies.push({x,y,hp:K.enemyHP});
}

/* ===== Update ===== */
function update(dt){
  if(S.over) return;
  S.t+=dt;

  // Movement
  let vx=0,vy=0;
  if(keys.has('KeyW'))vy-=1; if(keys.has('KeyS'))vy+=1;
  if(keys.has('KeyA'))vx-=1; if(keys.has('KeyD'))vx+=1;
  if(moveStick.active){ vx+=moveStick.vec.x; vy+=moveStick.vec.y; }
  const len=Math.hypot(vx,vy)||1; vx/=len; vy/=len;
  S.p.x=clamp(S.p.x+vx*K.playerSpeed*dt,0,K.worldW);
  S.p.y=clamp(S.p.y+vy*K.playerSpeed*dt,0,K.worldH);

  // PC Schie√üen (Maus)
  if(mouse.down && S.p.cd<=0){ shootAt(S.cam.x+mouse.x, S.cam.y+mouse.y); }
  if(S.p.cd>0) S.p.cd-=dt;

  // Bullets
  for(const b of S.bullets){ b.x+=b.vx*dt; b.y+=b.vy*dt; b.life-=dt; }
  S.bullets=S.bullets.filter(b=>b.life>0 && b.x>-80 && b.y>-80 && b.x<K.worldW+80 && b.y<K.worldH+80);

  // Enemies move to player
  for(const e of S.enemies){
    const dx=S.p.x-e.x, dy=S.p.y-e.y, d=Math.hypot(dx,dy)||1;
    e.x+=dx/d*K.enemySpeed*dt; e.y+=dy/d*K.enemySpeed*dt;
  }

  // Collisions bullet -> enemy
  let killed=false;
  for(let i=S.enemies.length-1;i>=0;i--){
    const e=S.enemies[i];
    let dead=false;
    for(let j=S.bullets.length-1;j>=0;j--){
      const b=S.bullets[j];
      if((b.x-e.x)**2+(b.y-e.y)**2 < 18*18){
        e.hp-=b.dmg; S.bullets.splice(j,1);
        if(e.hp<=0){ dead=true; break; }
      }
    }
    if(dead){
      S.enemies.splice(i,1);
      S.score+=10; S.coins+=K.coinPerKill; killed=true;
    }
  }
  if(killed){ updateHUD(); autosaveKick(); }

  // Enemy -> player (zuverl√§ssiger Schaden + i-frames + Pushback)
  if(S.hitCD>0) S.hitCD -= dt;
  for(const e of S.enemies){
    const dx=e.x-S.p.x, dy=e.y-S.p.y;
    const d2 = dx*dx + dy*dy;
    if(d2 < 32*32 && S.hitCD<=0){        // gro√üz√ºgigerer Radius = 32px
      S.p.hp = Math.max(0, S.p.hp-1);    // 1 Herz
      S.hitCD = 0.6;                     // 600ms Unverwundbarkeit
      const d = Math.hypot(dx,dy)||1;    // Gegner wegsto√üen
      e.x += (dx/d)*40; e.y += (dy/d)*40;
    }
  }

  // Highscore
  if(S.score > S.best) S.best = S.score;

  // Spawning
  S.nextSpawn-=dt;
  if(S.nextSpawn<=0){
    spawnEnemy();
    if(Math.random()<0.2) spawnEnemy();
    S.nextSpawn=K.spawnEvery;
  }

  // Camera follow
  const tx=clamp(S.p.x-canvas.width/2,0,K.worldW-canvas.width);
  const ty=clamp(S.p.y-canvas.height/2,0,K.worldH-canvas.height);
  S.cam.x += (tx-S.cam.x)*0.18;
  S.cam.y += (ty-S.cam.y)*0.18;

  // Autosave
  autosaveT += dt;
  if(autosaveT > 5){ saveGame(); autosaveT = 0; }

  updateHUD();
  if(S.p.hp<=0 && !S.over){
    S.over=true;
    byId('center').style.display='block';
    saveGame();
  }
}

/* ===== Draw ===== */
function draw(){
  const w=canvas.width,h=canvas.height,cam=S.cam;
  g.clearRect(0,0,w,h);

  g.save(); g.translate(-cam.x,-cam.y);

  // Grid
  g.globalAlpha=.25; g.strokeStyle='#1b2130'; g.lineWidth=1; g.beginPath();
  for(let x=0;x<=K.worldW;x+=64){ g.moveTo(x,0); g.lineTo(x,K.worldH); }
  for(let y=0;y<=K.worldH;y+=64){ g.moveTo(0,y); g.lineTo(K.worldW,y); }
  g.stroke(); g.globalAlpha=1;

  // Enemies
  g.fillStyle='#ef4444';
  for(const e of S.enemies){ g.beginPath(); g.arc(e.x,e.y,14,0,Math.PI*2); g.fill(); }

  // Player
  g.fillStyle='#60a5fa'; g.beginPath(); g.arc(S.p.x,S.p.y,16,0,Math.PI*2); g.fill();

  // Bullets
  g.fillStyle='#fde047';
  for(const b of S.bullets){ g.beginPath(); g.arc(b.x,b.y,4,0,Math.PI*2); g.fill(); }

  // Schuss-Vorschau beim rechten Stick (nur mobile, w√§hrend Halten)
  if(isTouch && shootStick.active){
    const ang=Math.atan2(shootStick.vec.y, shootStick.vec.x);
    const len=110;
    g.strokeStyle='#ffffff'; g.globalAlpha=.85; g.lineWidth=2;
    g.beginPath(); g.moveTo(S.p.x, S.p.y); g.lineTo(S.p.x + Math.cos(ang)*len, S.p.y + Math.sin(ang)*len); g.stroke();
    g.globalAlpha=1;
  }

  g.restore();

  // Cursor ring (PC)
  g.save(); g.strokeStyle='#fff'; g.globalAlpha=.9; g.lineWidth=2; g.beginPath();
  g.arc(mouse.x,mouse.y,9,0,Math.PI*2); g.stroke(); g.restore();
}

/* ===== HUD ===== */
function updateHUD(){
  byId('score').textContent=S.score|0;
  byId('best').textContent=S.best|0;
  byId('coins').textContent=S.coins|0;
  byId('weaponName').textContent=getW(S.p.weapon).name;
  coinsShop.textContent=S.coins|0;
  bestShop.textContent=S.best|0;
  const hearts=byId('hearts'); hearts.innerHTML='';
  for(let i=0;i<K.playerMaxHP;i++){
    const h=document.createElement('div'); h.className='heart'+(i<S.p.hp?'':' off'); hearts.appendChild(h);
  }
}
function autosaveKick(){ autosaveT = Math.min(autosaveT, 4.5); }

/* ===== Loop & Restart Shortcuts ===== */
let last=performance.now();
function tick(now){ const dt=Math.min(.033,(now-last)/1000); last=now; update(dt); draw(); requestAnimationFrame(tick); }
requestAnimationFrame(tick);

// Neustart per Klick/Touch im Game-Over
addEventListener('pointerdown', ()=>{ if(S.over) resetGame(); });

})();
</script>
</body>
</html>
