<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<title>Mini Shooter — Lobby + Offline/Online (FFA) • Neo‑Cartoon Glass</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<style>
  /*
    Design-Ziele:
    - Neo‑Cartoon: klare Outlines, simple Formen, dezente Neon-Akzente
    - iOS‑Glas: translucente Karten, Blur, weiche Schatten
    - Nicht zu grell: gedämpfte Pastell‑Palette mit punktuellen Glows
  */
  :root{
    --txt:#0e1116; 
    --bg1:#eaf2ff; --bg2:#f7fbff; /* Hintergrundverlauf */
    --glass:rgba(255,255,255,.6); /* Grundglas */
    --glass-strong:rgba(255,255,255,.75);
    --stroke:#0e1116; /* Cartoon-Outline */
    --bshadow:0 8px 24px rgba(14,17,22,.18), inset 0 1px 0 rgba(255,255,255,.45);
    --cardBorder:1.5px solid rgba(14,17,22,.12);

    /* Akzentfarben (leicht neon, nicht grell) */
    --blue:#7cb8ff; --cyan:#6ae1df; --mint:#82f3c6; --amber:#ffd98a; --rose:#ff8aa0; --violet:#bfa8ff;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;height:100%;color:var(--txt);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  body{background:linear-gradient(180deg,var(--bg1),var(--bg2)); overflow:hidden}

  /* sanftes Halftone/Noise fürs Papierfeeling */
  body::before{content:"";position:fixed;inset:0;pointer-events:none;background:
    radial-gradient(1200px 800px at 70% 20%,rgba(255,255,255,.6),rgba(255,255,255,0) 65%),
    radial-gradient(1200px 800px at 25% 80%,rgba(255,255,255,.55),rgba(255,255,255,0) 65%);
    mix-blend-mode:screen; z-index:0}

  #game{position:fixed;inset:0;width:100vw;height:100vh;display:block;touch-action:none;user-select:none}

  /* ===== HUD (Glas + Cartoon) ===== */
  #hud{position:fixed;top:12px;left:12px;z-index:10;display:flex;gap:10px;align-items:center;
       background:var(--glass);backdrop-filter:blur(14px) saturate(1.05);
       border:var(--cardBorder); border-radius:16px; padding:10px 12px; box-shadow:var(--bshadow)}
  .title{font-weight:900;letter-spacing:.3px;font-size:14px}
  .hp{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:12px;background:var(--glass-strong);
      backdrop-filter:blur(12px); border:var(--cardBorder)}
  .hpbar{width:150px;height:12px;border-radius:999px;background:rgba(14,17,22,.06);overflow:hidden;border:var(--cardBorder)}
  .hpfill{width:100%;height:100%;background:linear-gradient(90deg,var(--mint),var(--blue));transition:width .18s;
          box-shadow:0 0 14px rgba(130,243,198,.45)}
  .badge,.coins,.mode{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:12px;background:var(--glass-strong);
      border:var(--cardBorder);backdrop-filter:blur(12px);font-weight:900}
  .coins{background:rgba(255,217,138,.25)}

  /* Leave button */
  #btnLeave{position:fixed;top:12px;right:12px;z-index:11;appearance:none;border:var(--cardBorder);
    background:var(--glass-strong);backdrop-filter:blur(12px);color:var(--txt);border-radius:12px;padding:10px 14px;font-weight:900;
    cursor:pointer;box-shadow:var(--bshadow)}
  #btnLeave:hover{filter:brightness(1.03)}

  /* Hinweisleiste */
  #hint{position:fixed;bottom:44px;left:50%;transform:translateX(-50%);z-index:9;background:var(--glass-strong);
        backdrop-filter:blur(12px);border:var(--cardBorder); box-shadow:var(--bshadow);
        padding:8px 12px;border-radius:12px;font-size:13px;text-align:center}

  /* Start-Overlay (nur für PointerLock) */
  #overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(14,17,22,.25);z-index:20;cursor:pointer}
  #overlay .box{padding:28px 40px;border-radius:20px;text-align:center;background:var(--glass-strong);
    border:var(--cardBorder);box-shadow:var(--bshadow)}
  #overlay h1{margin:0;font-size:30px}
  #overlay p{margin-top:8px;font-size:14px;opacity:.85}

  /* Touch-Zonen */
  .touch-zone{position:fixed;bottom:0;height:45%;width:50%;z-index:5}
  #leftZone{left:0;} #rightZone{right:0;}
  #joy{position:fixed;left:0;top:0;pointer-events:none;z-index:6}

  /* Footer */
  #footer{position:fixed;right:12px;bottom:12px;z-index:9;background:var(--glass-strong);border:var(--cardBorder);
    padding:6px 10px;border-radius:12px;box-shadow:var(--bshadow);font-size:12px}

  /* ======= LOBBY ======= */
  #menu{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:30}
  .menu-card{width:min(92vw,880px);padding:22px;border-radius:18px;background:var(--glass-strong);backdrop-filter:blur(18px);
    border:var(--cardBorder); box-shadow:var(--bshadow)}
  .menu-head{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .menu-title{font-size:26px;font-weight:1000;letter-spacing:.4px}
  .menu-tabs{display:flex;gap:8px}
  .btn{appearance:none;border:var(--cardBorder);background:var(--glass-strong);backdrop-filter:blur(12px);
       color:var(--txt);border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer;box-shadow:var(--bshadow)}
  .btn:hover{filter:brightness(1.04)}
  .btn.primary{background:linear-gradient(180deg,rgba(124,184,255,.35),rgba(106,225,223,.25));}
  .menu-body{display:grid;grid-template-columns:1fr;gap:14px;margin-top:16px}
  .menu-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .pill{padding:8px 12px;border-radius:999px;border:var(--cardBorder);background:var(--glass);font-weight:800}
  .skin-list{display:flex;gap:12px;flex-wrap:wrap}
  .skin{width:64px;height:64px;border-radius:16px;border:var(--cardBorder);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;background:var(--glass);backdrop-filter:blur(10px)}
  .skin.active{outline:3px solid rgba(124,184,255,.75); box-shadow:0 0 24px rgba(124,184,255,.45)}
  .skin .dot{width:30px;height:30px;border-radius:999px;border:1.5px solid rgba(14,17,22,.2)}
  .skin.aqua .dot{background:linear-gradient(135deg,var(--cyan),var(--blue))}
  .skin.red .dot{background:linear-gradient(135deg,var(--rose),#ffb0bf)}
  .skin.purple .dot{background:linear-gradient(135deg,var(--violet),var(--blue))}
  .skin.gold .dot{background:linear-gradient(135deg,var(--amber),#ffaf6b)}
  .skin.mint .dot{background:linear-gradient(135deg,var(--mint),var(--cyan))}
  .skin.locked::before{content:"LOCK";position:absolute;bottom:-8px;right:-8px;background:rgba(14,17,22,.9); color:#fff; font-weight:900; font-size:10px;padding:3px 6px;border-radius:8px;border:var(--cardBorder)}
  .muted{opacity:.85}

  /* Shop */
  .shop-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .card{border:var(--cardBorder);background:var(--glass-strong);backdrop-filter:blur(12px);border-radius:14px;padding:12px;box-shadow:var(--bshadow)}
  .card h4{margin:0 0 6px 0}
  .price{font-weight:1000}

  /* Mode Picker */
  #modePicker{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(14,17,22,.15);z-index:40}
  #modePicker .box{padding:24px;border-radius:16px;background:var(--glass-strong);backdrop-filter:blur(18px);border:var(--cardBorder);width:min(92vw,520px);box-shadow:var(--bshadow)}
  #modePicker h3{margin:0 0 12px 0}
  .mode-buttons{display:flex;gap:10px;flex-wrap:wrap}
</style>
</head>
<body>
<canvas id="game"></canvas>

<!-- HUD -->
<div id="hud">
  <div class="title">MINI SHOOTER</div>
  <div class="hp">
    <span style="opacity:.85;font-weight:900;">HP</span>
    <div class="hpbar"><div class="hpfill" id="hpfill"></div></div>
    <span id="hptext" style="min-width:26px;text-align:right;font-weight:1000;">3</span>
  </div>
  <div class="badge">SCORE <span id="score" style="font-weight:1000;margin-left:6px">0</span></div>
  <div class="coins">⛁ <span id="coins">0</span></div>
  <div class="mode" id="modeBadge" title="Spielmodus">OFFLINE</div>
</div>
<button id="btnLeave" style="display:none">Verlassen</button>

<div id="hint">
  <span id="hintDesktop">Klicke auf PLAY • WASD bewegen • Maus halten = Schießen</span>
  <span id="hintMobile" style="display:none">Tippe auf PLAY • Links bewegen (Joystick) • Rechts tippen/halten = Schießen</span>
</div>

<!-- Footer credits -->
<div id="footer">created by: <b>Aras</b> • First tester: <b>Bertuğ</b></div>

<!-- Start-Overlay (nur wenn Pointer-Lock möglich) -->
<div id="overlay">
  <div class="box">
    <h1 id="startTitle">CLICK TO START</h1>
    <p id="startSub">Maus wird gesperrt • danach sofort loslegen</p>
  </div>
</div>

<!-- Mobile: unsichtbare Touch-Zonen + Joystick-Canvas -->
<div id="leftZone" class="touch-zone" style="display:none"></div>
<div id="rightZone" class="touch-zone" style="display:none"></div>
<canvas id="joy" width="1" height="1"></canvas>

<!-- ======= LOBBY / MENU (sichtbar zuerst) ======= -->
<div id="menu">
  <div class="menu-card">
    <div class="menu-head">
      <div class="menu-title">MINI SHOOTER — Lobby</div>
      <div class="menu-tabs">
        <button class="btn" id="btnShop">Shop</button>
        <button class="btn" id="btnSkins">Skins</button>
        <button class="btn primary" id="btnPlay">Play</button>
      </div>
    </div>
    <div class="menu-body">
      <div id="paneHome">
        <div class="menu-row"><span class="pill">Modus:</span> <span class="muted">Free for All • Endlos</span></div>
        <div class="menu-row"><span class="pill">Steuerung:</span> <span class="muted">Desktop: WASD + Maus • Mobile: Joystick + Tippen</span></div>
      </div>
      <div id="paneShop" style="display:none">
        <div class="menu-row"><span class="pill">Deine Coins:</span> <b id="shopCoins">0</b></div>
        <div class="shop-grid" id="shopList"></div>
      </div>
      <div id="paneSkins" style="display:none">
        <div class="menu-row"><span class="pill">Wähle deinen Skin:</span></div>
        <div class="skin-list" id="skinList"></div>
      </div>
    </div>
  </div>
</div>

<!-- Mode Picker (öffnet über Lobby nach Klick auf Play) -->
<div id="modePicker">
  <div class="box">
    <h3>Spielmodus wählen</h3>
    <div class="menu-row"><span class="pill">Max. Personen Online:</span> <b>5</b> • <span class="pill">Max. Leben Online:</span> <b>4</b></div>
    <div class="mode-buttons">
      <button class="btn primary" id="modeOffline">Offline</button>
      <button class="btn" id="modeOnline">Online (FFA, Beta)</button>
      <button class="btn" id="modeCancel">Abbrechen</button>
    </div>
    <p class="muted" style="margin-top:8px">Online (Beta): keine KI-Gegner, FFA, Platzhalter bis echte Multiplayer-Verbindung steht.</p>
  </div>
</div>

<script>
(()=> {
  // --- Helpers / Env ---
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || (navigator.maxTouchPoints||0) > 0;

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const overlay = document.getElementById('overlay');
  const startTitle = document.getElementById('startTitle');
  const startSub   = document.getElementById('startSub');
  const hpfill = document.getElementById('hpfill');
  const hptext = document.getElementById('hptext');
  const scoreEl = document.getElementById('score');
  const coinsEl = document.getElementById('coins');
  const modeBadge = document.getElementById('modeBadge');
  const btnLeave = document.getElementById('btnLeave');

  const hintDesktop = document.getElementById('hintDesktop');
  const hintMobile  = document.getElementById('hintMobile');
  const leftZone = document.getElementById('leftZone');
  const rightZone = document.getElementById('rightZone');
  const joyCanvas = document.getElementById('joy'); const jctx = joyCanvas.getContext('2d');

  const menu = document.getElementById('menu');
  const btnPlay = document.getElementById('btnPlay');
  const btnShop = document.getElementById('btnShop');
  const btnSkins= document.getElementById('btnSkins');
  const paneHome= document.getElementById('paneHome');
  const paneShop= document.getElementById('paneShop');
  const paneSkins= document.getElementById('paneSkins');
  const skinList = document.getElementById('skinList');
  const shopList = document.getElementById('shopList');
  const shopCoins= document.getElementById('shopCoins');

  const modePicker = document.getElementById('modePicker');
  const modeOfflineBtn = document.getElementById('modeOffline');
  const modeOnlineBtn  = document.getElementById('modeOnline');
  const modeCancelBtn  = document.getElementById('modeCancel');

  // Detect iframe (sandbox) and pointer-lock availability
  const inIframe = (()=>{ try{ return window.self !== window.top; }catch(e){ return true; } })();
  const pointerLockAPISupported = !!(canvas.requestPointerLock && 'pointerLockElement' in document);
  let POINTER_LOCK_ENABLED = pointerLockAPISupported && !inIframe; // Disable in sandboxed iframes

  // ==== Persistence (Inventory/Coins) ====
  const INV_KEY = 'ms_inv_v1';
  const SKIN_KEY = 'ms_skin_v1';
  const DEFAULT_INV = {
    coins: 0,
    items: { trail: false },
    upgrades: { firerate: 0, hp: 0 }, // firerate max 3, hp max +2 (Offline). Online capped.
    ownedSkins: { aqua:true, red:true, purple:false, gold:false, mint:true }
  };
  function loadInv(){
    try{ const raw = JSON.parse(localStorage.getItem(INV_KEY)||'{}');
      return {
        coins: (raw.coins??DEFAULT_INV.coins),
        items: Object.assign({}, DEFAULT_INV.items, raw.items||{}),
        upgrades: Object.assign({}, DEFAULT_INV.upgrades, raw.upgrades||{}),
        ownedSkins: Object.assign({}, DEFAULT_INV.ownedSkins, raw.ownedSkins||{}),
      };
    } catch(e){ return JSON.parse(JSON.stringify(DEFAULT_INV)); }
  }
  function saveInv(){ localStorage.setItem(INV_KEY, JSON.stringify(INV)); refreshCoins(); }
  let INV = loadInv();

  function refreshCoins(){ coinsEl.textContent = INV.coins; shopCoins.textContent = INV.coins; }

  // Mode state
  let GAME_MODE = 'OFFLINE'; // or 'ONLINE'
  const MAX_ONLINE_PLAYERS = 5;
  const MAX_ONLINE_LIVES = 4;
  modeBadge.textContent = GAME_MODE;

  // UI je nach Gerät
  if(isMobile){
    startTitle.textContent = 'TAP TO START';
    startSub.textContent   = 'Links bewegen • Rechts schießen • Heals aufsammeln';
    hintDesktop.style.display='none';
    hintMobile.style.display='inline';
    leftZone.style.display = rightZone.style.display = 'block';
  } else if (!POINTER_LOCK_ENABLED) {
    startTitle.textContent = 'PRESS START';
    startSub.textContent   = 'Maus bleibt frei (kein Pointer-Lock)';
    hintDesktop.textContent = 'Klicke auf PLAY • WASD bewegen • Maus halten = Schießen';
  }

  function resize(){
    const dpr = Math.min(2, window.devicePixelRatio||1);
    canvas.width = Math.floor(innerWidth * dpr);
    canvas.height = Math.floor(Math.max(1,innerHeight) * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    joyCanvas.width = innerWidth; joyCanvas.height = innerHeight; // UI in CSS-Pixeln
  }
  addEventListener('resize', resize, {passive:true}); resize(); refreshCoins();

  // Safe Pointer lock wrapper
  function lock(){
    if(isMobile || !POINTER_LOCK_ENABLED) return; // no-op
    try { canvas.requestPointerLock(); }
    catch(err){
      console.warn('Pointer-Lock deaktiviert (caught):', err);
      POINTER_LOCK_ENABLED = false;
      overlay.style.display = 'none';
    }
  }
  document.addEventListener('pointerlockerror', (e)=>{
    console.warn('Pointer-Lock error event:', e);
    POINTER_LOCK_ENABLED = false;
    overlay.style.display = 'none';
  });
  document.addEventListener('pointerlockchange', ()=>{
    if(isMobile || !pointerLockAPISupported) return;
    overlay.style.display = (document.pointerLockElement===canvas)?'none':'flex';
  });

  // ======= LOBBY UI =======
  function showPane(which){
    paneHome.style.display = which==='home'? 'block':'none';
    paneShop.style.display = which==='shop'? 'block':'none';
    paneSkins.style.display= which==='skins'?'block':'none';
  }
  showPane('home');

  btnShop.addEventListener('click', ()=>{showPane('shop'); renderShop();});
  btnSkins.addEventListener('click', ()=>{showPane('skins');});
  btnPlay.addEventListener('click', ()=>{ modePicker.style.display='flex'; });
  modeCancelBtn.addEventListener('click', ()=>{ modePicker.style.display='none'; });

  // ======= Mode Auswahl =======
  modeOfflineBtn.addEventListener('click', ()=>{
    GAME_MODE='OFFLINE'; modeBadge.textContent=GAME_MODE; modePicker.style.display='none';
    startFromLobby();
  });
  modeOnlineBtn.addEventListener('click', ()=>{
    GAME_MODE='ONLINE'; modeBadge.textContent=`${GAME_MODE} 1/${MAX_ONLINE_PLAYERS}`; modePicker.style.display='none';
    startFromLobby();
  });

  function startFromLobby(){
    menu.style.display='none';
    btnLeave.style.display='inline-block';
    if(isMobile || !POINTER_LOCK_ENABLED){ resetGame(); startGame(); }
    else{ overlay.style.display='flex'; }
  }

  // ======= Shop =======
  const SHOP = [
    { id:'trail', type:'toggle', title:'Comet Trail', desc:'Kosmetik: Partikelspur hinter Schüssen', price:50 },
    { id:'firerate', type:'upgrade', title:'Fire Rate+', desc:'Schneller schießen', price:[100,150,200], max:3 },
    { id:'hp', type:'upgrade', title:'Max HP+', desc:'Maximale Leben erhöhen (nur Offline über 4)', price:[120,180], max:2 },
  ];

  function renderShop(){
    refreshCoins();
    shopList.innerHTML='';
    for(const item of SHOP){
      const card=document.createElement('div'); card.className='card';
      const state = (item.type==='toggle')? (INV.items[item.id]?'Aktiv':'Inaktiv')
                    : (INV.upgrades[item.id]||0)+` / ${item.max}`;
      let priceTxt = '';
      if(item.type==='toggle') priceTxt = !INV.items[item.id] ? `${item.price}⛁` : 'gekauft';
      if(item.type==='upgrade'){
        const lvl = INV.upgrades[item.id]||0;
        priceTxt = (lvl < item.max) ? `${item.price[lvl]}⛁` : 'max';
      }
      card.innerHTML = `
        <h4>${item.title}</h4>
        <div class="muted" style="margin-bottom:6px">${item.desc}</div>
        <div class="menu-row">
          <span class="pill">Status:</span> <b>${state}</b>
          <span class="pill">Preis:</span> <b class="price">${priceTxt}</b>
        </div>
      `;
      const btn=document.createElement('button'); btn.className='btn';
      if(item.type==='toggle'){
        btn.textContent = INV.items[item.id] ? 'Deaktivieren' : 'Kaufen & Aktivieren';
        btn.onclick=()=>{
          if(!INV.items[item.id]){
            if(INV.coins>=item.price){ INV.coins-=item.price; INV.items[item.id]=true; saveInv(); renderShop(); }
            else alert('Nicht genug Coins.');
          } else { INV.items[item.id]=false; saveInv(); renderShop(); }
        };
      } else if(item.type==='upgrade'){
        btn.textContent = 'Upgrade';
        btn.disabled = (INV.upgrades[item.id]||0) >= item.max;
        btn.onclick=()=>{
          const lvl = INV.upgrades[item.id]||0; if(lvl>=item.max) return;
          const cost = item.price[lvl];
          if(INV.coins>=cost){ INV.coins-=cost; INV.upgrades[item.id]=lvl+1; saveInv(); renderShop(); }
          else alert('Nicht genug Coins.');
        };
      }
      card.appendChild(btn);
      shopList.appendChild(card);
    }

    // Skins-Angebote (nur gelockte)
    const SKINS_DATA = [
      {id:'purple', name:'Purple', price:60},
      {id:'gold',   name:'Gold',   price:80}
    ];
    const lockedSkins = SKINS_DATA.filter(s=>!(INV.ownedSkins||{})[s.id]);
    if(lockedSkins.length){
      const wrap=document.createElement('div'); wrap.className='card';
      wrap.innerHTML='<h4>Skins freischalten</h4>';
      const row=document.createElement('div'); row.className='menu-row';
      for(const s of lockedSkins){
        const b=document.createElement('button'); b.className='btn';
        b.textContent = `${s.name} – ${s.price}⛁`;
        b.onclick=()=>{ if(confirm(`${s.name} für ${s.price}⛁ kaufen?`)) tryBuySkin(s.id); };
        row.appendChild(b);
      }
      wrap.appendChild(row); shopList.appendChild(wrap);
    }
  }

  // ============ GAME STATE ============
  let S=null, RAF=null;
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const ang=(x1,y1,x2,y2)=>Math.atan2(y2-y1,x2-x1);
  const d2=(x1,y1,x2,y2)=>{const dx=x2-x1,dy=y2-y1;return dx*dx+dy*dy};

  const skins = [
    {id:'aqua',   name:'Aqua',   colors:['#6ae1df','#7cb8ff'], price:0},
    {id:'red',    name:'Red',    colors:['#ff8aa0','#ffb6c3'], price:0},
    {id:'purple', name:'Purple', colors:['#bfa8ff','#8eb1ff'], price:60},
    {id:'gold',   name:'Gold',   colors:['#ffd98a','#ffb782'], price:80},
    {id:'mint',   name:'Mint',   colors:['#82f3c6','#6ae1df'], price:0}
  ];
  let currentSkinId = localStorage.getItem(SKIN_KEY) || 'aqua';
  function getSkinById(id){ return skins.find(s=>s.id===id) || skins[0]; }
  function ownSkin(id){ return !!INV.ownedSkins[id]; }
  function tryBuySkin(id){
    const s = skins.find(x=>x.id===id); if(!s) return;
    if(ownSkin(id)) return;
    const price = {purple:60, gold:80}[id]||0;
    if(INV.coins >= price){ INV.coins -= price; INV.ownedSkins[id]=true; saveInv(); renderSkinChoices(); renderShop(); }
    else alert('Nicht genug Coins.');
  }

  function resetGame(){
    const skin = getSkinById(currentSkinId);
    const offlineHpMax = 3 + (INV.upgrades.hp||0);
    const hpCap = (GAME_MODE==='ONLINE') ? 4 : Infinity; // Online cap 4
    const hpMax = Math.min(offlineHpMax, hpCap);
    S = {
      run:true, score:0,
      px: innerWidth/2, py: innerHeight/2, pr:13, speed: isMobile? 300 : 260,
      hp: hpMax, hpMax,
      keys:{}, mouse:{x:innerWidth/2, y:innerHeight/2, down:false},
      bullets:[], enemies:[], heals:[],
      spawnT:0, shootT:0, healT: 3.0,
      aimR:52,
      skin,
      moveTouchId:null, moveStartX:0, moveStartY:0, moveDX:0, moveDY:0,
      shootTouchId:null
    };
    updHP(); updScore();
    if(GAME_MODE==='OFFLINE'){
      for(let i=0;i<8;i++) spawnEnemy();
    }
    clearJoystick();
  }

  function updHP(){
    if(!S) return;
    hptext.textContent = S.hp;
    const pct = S.hp/S.hpMax;
    hpfill.style.width = (pct*100)+'%';
    hpfill.style.background = pct>0.66 ? 'linear-gradient(90deg,var(--mint),var(--cyan))'
                          : pct>0.33 ? 'linear-gradient(90deg,var(--amber),#ffb782)'
                                     : 'linear-gradient(90deg,var(--rose),#ffb6c3)';
  }
  function updScore(){ scoreEl.textContent = S? S.score: 0; refreshCoins(); }

  function leaveToLobby(){
    try{ document.exitPointerLock?.(); }catch(_){ }
    if(S) S.run=false; cancelAnimationFrame(RAF); RAF=null;
    btnLeave.style.display='none';
    menu.style.display='flex';
    modeBadge.textContent = GAME_MODE==='ONLINE' ? `${GAME_MODE} 1/${MAX_ONLINE_PLAYERS}` : 'OFFLINE';
    ctx.clearRect(0,0,innerWidth,innerHeight);
  }
  btnLeave.addEventListener('click', leaveToLobby);

  // Keyboard (Desktop)
  addEventListener('keydown', e=>{
    if(!S) return;
    S.keys[e.code]=true;
    if(e.code==='Escape'){ document.exitPointerLock?.(); leaveToLobby(); }
    if(!S.run && !isMobile && e.code==='Space'){ resetGame(); startGame(); }
  });
  addEventListener('keyup', e=>{ if(S) S.keys[e.code]=false; });

  // Mouse (Desktop)
  canvas.addEventListener('mousedown', ()=>{ if(S) { S.mouse.down=true; if(!isMobile && POINTER_LOCK_ENABLED) lock(); }});
  addEventListener('mouseup', ()=>{ if(S) S.mouse.down=false; });
  addEventListener('mousemove', e=>{
    if(!S) return;
    if(!isMobile && POINTER_LOCK_ENABLED && document.pointerLockElement===canvas){
      S.mouse.x = clamp(S.mouse.x + e.movementX, 0, innerWidth);
      S.mouse.y = clamp(S.mouse.y + e.movementY, 0, innerHeight);
    } else {
      S.mouse.x = e.clientX; S.mouse.y = e.clientY;
    }
  }, {passive:true});

  // Touch (Mobile) — Glas-Joystick
  function drawJoystick(cx,cy,dx,dy){
    jctx.clearRect(0,0,joyCanvas.width, joyCanvas.height);
    jctx.save();
    // Outer glass ring
    jctx.fillStyle='rgba(255,255,255,.6)'; jctx.strokeStyle='rgba(14,17,22,.25)'; jctx.lineWidth=2;
    jctx.beginPath(); jctx.arc(cx,cy,60,0,Math.PI*2); jctx.fill(); jctx.stroke();
    // neon glow
    jctx.shadowBlur=16; jctx.shadowColor='rgba(124,184,255,.45)';
    // knob
    const kx=cx+dx, ky=cy+dy;
    jctx.fillStyle='rgba(124,184,255,.65)'; jctx.strokeStyle='rgba(14,17,22,.25)'; jctx.lineWidth=2;
    jctx.beginPath(); jctx.arc(kx,ky,26,0,Math.PI*2); jctx.fill(); jctx.stroke();
    jctx.restore();
  }
  function clearJoystick(){ jctx.clearRect(0,0,joyCanvas.width, joyCanvas.height); }
  function isLeft(x){ return x < innerWidth*0.5; }

  if(isMobile){
    canvas.addEventListener('touchstart', (e)=>{
      e.preventDefault(); if(!S) return;
      for(const t of e.changedTouches){
        if(isLeft(t.clientX) && S.moveTouchId===null){
          S.moveTouchId = t.identifier;
          S.moveStartX = t.clientX; S.moveStartY = t.clientY;
          S.moveDX=0; S.moveDY=0; drawJoystick(S.moveStartX,S.moveStartY,0,0);
        } else if(!isLeft(t.clientX) && S.shootTouchId===null){
          S.shootTouchId=t.identifier; S.mouse.down=true;
          S.mouse.x=t.clientX; S.mouse.y=t.clientY;
        }
      }
    }, {passive:false});

    canvas.addEventListener('touchmove', (e)=>{
      e.preventDefault(); if(!S) return;
      for(const t of e.changedTouches){
        if(t.identifier===S.moveTouchId){
          const dx=t.clientX-S.moveStartX, dy=t.clientY-S.moveStartY;
          const r=Math.hypot(dx,dy), maxR=60, s=r>maxR?maxR/r:1;
          S.moveDX=dx*s; S.moveDY=dy*s; drawJoystick(S.moveStartX,S.moveStartY,S.moveDX,S.moveDY);
        }
        if(t.identifier===S.shootTouchId){ S.mouse.x=t.clientX; S.mouse.y=t.clientY; }
      }
    }, {passive:false});

    function endTouch(e){
      e.preventDefault(); if(!S) return;
      for(const t of e.changedTouches){
        if(t.identifier===S.moveTouchId){ S.moveTouchId=null; S.moveDX=0; S.moveDY=0; clearJoystick(); }
        if(t.identifier===S.shootTouchId){ S.shootTouchId=null; S.mouse.down=false; }
      }
    }
    canvas.addEventListener('touchend', endTouch, {passive:false});
    canvas.addEventListener('touchcancel', endTouch, {passive:false});
  }

  /* ======= RENDER HELPERS (Neo‑Cartoon) ======= */
  function glow(fill, blur){ ctx.shadowBlur=blur; ctx.shadowColor=fill; }
  function noGlow(){ ctx.shadowBlur=0; }
  function circleOutline(x,y,r,fill){
    glow('rgba(124,184,255,.35)', 12);
    ctx.fillStyle=fill; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    noGlow(); ctx.lineWidth=2; ctx.strokeStyle='rgba(14,17,22,.25)'; ctx.stroke();
  }
  function capsule(x1,y1,x2,y2,w,fill){
    const a=Math.atan2(y2-y1,x2-x1), len=Math.hypot(x2-x1,y2-y1);
    ctx.save(); ctx.translate(x1,y1); ctx.rotate(a);
    glow('rgba(255,217,138,.35)',10);
    ctx.fillStyle=fill; ctx.beginPath();
    ctx.moveTo(0,-w/2); ctx.lineTo(len,-w/2); ctx.arc(len,0,w/2,-Math.PI/2,Math.PI/2);
    ctx.lineTo(0,w/2); ctx.arc(0,0,w/2,Math.PI/2,-Math.PI/2);
    ctx.closePath(); ctx.fill(); noGlow();
    ctx.lineWidth=2; ctx.strokeStyle='rgba(14,17,22,.25)'; ctx.stroke();
    ctx.restore();
  }

  // Spawns
  function spawnEnemy(){
    if(GAME_MODE==='ONLINE') return; // Online: keine KI
    const side=(Math.random()*4)|0; let x=0,y=0,m=24;
    if(side===0){x=Math.random()*innerWidth; y=-m;}
    if(side===1){x=innerWidth+m; y=Math.random()*innerHeight;}
    if(side===2){x=Math.random()*innerWidth; y=innerHeight+m;}
    if(side===3){x=-m; y=Math.random()*innerHeight;}
    const speed=80+Math.random()*80+Math.min(160,S.score*.7);
    const r=13+Math.random()*9;
    S.enemies.push({x,y,r,speed});
  }
  function spawnHeal(){
    if(GAME_MODE==='ONLINE') return; // Online: keine Heals
    const margin=40;
    const x = margin + Math.random()*(innerWidth - margin*2);
    const y = margin + Math.random()*(innerHeight - margin*2);
    S.heals.push({x,y,r:15,life:9+Math.random()*6,age:0});
  }

  // Start/Loop
  function startGame(){
    if(!S) resetGame();
    let last=performance.now();
    function loop(now){
      if(!S.run) return;
      const dt=Math.min(.033,(now-last)/1000); last=now;

      // Movement
      let vx=0, vy=0;
      if(S.keys['KeyW']||S.keys['ArrowUp']) vy-=1;
      if(S.keys['KeyS']||S.keys['ArrowDown']) vy+=1;
      if(S.keys['KeyA']||S.keys['ArrowLeft']) vx-=1;
      if(S.keys['KeyD']||S.keys['ArrowRight']) vx+=1;
      if(isMobile && S.moveTouchId!==null){ vx = S.moveDX/60; vy = S.moveDY/60; }
      if(vx||vy){ const L=Math.hypot(vx,vy); vx/=L; vy/=L; }
      S.px = clamp(S.px + vx*S.speed*dt, S.pr, innerWidth - S.pr);
      S.py = clamp(S.py + vy*S.speed*dt, S.pr, innerHeight - S.pr);

      // Shooting
      S.shootT -= dt;
      const baseCD = 0.12; const cd = Math.max(0.06, baseCD - 0.02*(INV.upgrades.firerate||0));
      if(S.mouse.down && S.shootT<=0){
        let a=ang(S.px,S.py,S.mouse.x,S.mouse.y);
        if(GAME_MODE==='OFFLINE'){
          let best=null,bestD=Infinity,R2=S.aimR*S.aimR;
          for(const e of S.enemies){
            const dx=e.x-S.mouse.x,dy=e.y-S.mouse.y,dd=dx*dx+dy*dy;
            if(dd<R2 && dd<bestD){bestD=dd;best=e;}
          }
          if(best) a = ang(S.px,S.py,best.x,best.y);
        }
        const spd=520;
        S.bullets.push({x:S.px+Math.cos(a)*S.pr,y:S.py+Math.sin(a)*S.pr,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,life:.9,trailAge:0});
        S.shootT = cd;
      }

      // Bullets
      for(let i=S.bullets.length-1;i>=0;i--){
        const b=S.bullets[i]; b.x+=b.vx*dt; b.y+=b.vy*dt; b.life-=dt; b.trailAge+=dt;
        if(b.life<=0||b.x<0||b.x>innerWidth||b.y<0||b.y>innerHeight) S.bullets.splice(i,1);
      }

      // Spawn pacing (nur Offline)
      if(GAME_MODE==='OFFLINE'){
        S.spawnT -= dt; if(S.spawnT<=0){ spawnEnemy(); S.spawnT=Math.max(.2, .8 - S.score*.01); }
        S.healT  -= dt; if(S.healT<=0){ if(Math.random()<0.7) spawnHeal(); S.healT = 6 + Math.random()*4; }
      }

      // Enemies (nur Offline)
      if(GAME_MODE==='OFFLINE'){
        for(let i=S.enemies.length-1;i>=0;i--){
          const e=S.enemies[i]; const a=ang(e.x,e.y,S.px,S.py);
          e.x+=Math.cos(a)*e.speed*dt; e.y+=Math.sin(a)*e.speed*dt;
          // bullet hits
          let hit=false;
          for(let j=S.bullets.length-1;j>=0;j--){
            const b=S.bullets[j];
            if(d2(b.x,b.y,e.x,e.y) <= e.r*e.r){ S.bullets.splice(j,1); hit=true; break; }
          }
          if(hit){ S.enemies.splice(i,1); S.score++; INV.coins += 1; saveInv(); updScore(); continue; }
          // player hit
          if(d2(S.px,S.py,e.x,e.y) <= (S.pr+e.r)*(S.pr+e.r)){
            S.hp--; updHP(); S.enemies.splice(i,1);
            if(S.hp<=0){ gameOver(); return; }
          }
        }
      }

      // Heals (nur Offline)
      if(GAME_MODE==='OFFLINE'){
        for(let i=S.heals.length-1;i>=0;i--){
          const h=S.heals[i]; h.age+=dt; h.life-=dt;
          if(d2(S.px,S.py,h.x,h.y) <= (S.pr+h.r)*(S.pr+h.r)){
            if(S.hp<S.hpMax){ S.hp++; updHP(); }
            S.heals.splice(i,1); continue;
          }
          if(h.life<=0) S.heals.splice(i,1);
        }
      }

      // ===== RENDER =====
      ctx.clearRect(0,0,innerWidth,innerHeight);

      // Soft grid dots (dezent)
      const step=46;
      ctx.fillStyle='rgba(124,184,255,.18)';
      for(let x=0;x<=innerWidth;x+=step){
        for(let y=0;y<=innerHeight;y+=step){
          ctx.beginPath(); ctx.arc(x+6,y+6,1.6,0,Math.PI*2); ctx.fill();
        }
      }

      // Aim Kreis + Crosshair (leicht glasig)
      ctx.save(); glow('rgba(124,184,255,.35)',8);
      ctx.strokeStyle='rgba(14,17,22,.25)'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(S.mouse.x,S.mouse.y,S.aimR,0,Math.PI*2); ctx.stroke();
      ctx.beginPath(); const size=14;
      ctx.moveTo(S.mouse.x-size,S.mouse.y); ctx.lineTo(S.mouse.x+size,S.mouse.y);
      ctx.moveTo(S.mouse.x,S.mouse.y-size); ctx.lineTo(S.mouse.x,S.mouse.y+size);
      ctx.stroke(); noGlow(); ctx.restore();

      // Bullets (glasig gelb)
      for(const b of S.bullets){
        if(INV.items.trail){
          const tx=b.x-b.vx*0.04, ty=b.y-b.vy*0.04;
          capsule(tx,ty,b.x,b.y,8,'rgba(255,255,255,.9)');
        }
        const tx=b.x-b.vx*.03, ty=b.y-b.vy*.03;
        capsule(tx,ty,b.x,b.y,8,'rgba(255,217,138,.95)');
      }

      // Enemies (Offline)
      if(GAME_MODE==='OFFLINE'){
        for(const e of S.enemies){ circleOutline(e.x,e.y,e.r,'#ffb782'); }
      }

      // Heals (Offline)
      if(GAME_MODE==='OFFLINE'){
        for(const h of S.heals){ circleOutline(h.x,h.y,h.r,'#82f3c6');
          ctx.lineWidth=2; ctx.strokeStyle='rgba(14,17,22,.35)';
          ctx.beginPath(); ctx.moveTo(h.x-h.r*0.5,h.y); ctx.lineTo(h.x+h.r*0.5,h.y);
          ctx.moveTo(h.x,h.y-h.r*0.5); ctx.lineTo(h.x,h.y+h.r*0.5); ctx.stroke(); }
      }

      // Player
      const pa=ang(S.px,S.py,S.mouse.x,S.mouse.y);
      ctx.save(); ctx.translate(S.px,S.py); ctx.rotate(pa);
      const skin = getSkinById(currentSkinId);
      glow('rgba(124,184,255,.35)',12);
      ctx.fillStyle=skin.colors[0]; ctx.beginPath(); ctx.arc(0,0,S.pr,0,Math.PI*2); ctx.fill();
      noGlow(); ctx.lineWidth=2; ctx.strokeStyle='rgba(14,17,22,.25)'; ctx.stroke();
      // cannon (glasiger Stab)
      glow('rgba(124,184,255,.25)',6);
      ctx.strokeStyle='rgba(124,184,255,.75)'; ctx.lineWidth=8; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(S.pr+16,0); ctx.stroke();
      noGlow();
      ctx.restore();

      RAF=requestAnimationFrame(loop);
    }
    RAF=requestAnimationFrame(loop);
  }

  // ======= GAME OVER =======
  function gameOver(){
    S.run=false;
    ctx.fillStyle="rgba(14,17,22,.15)"; ctx.fillRect(0,0,innerWidth,innerHeight);
    ctx.fillStyle="#0e1116"; ctx.font="900 32px Arial"; ctx.textAlign="center";
    ctx.fillText("GAME OVER", innerWidth/2, innerHeight/2-18);
    ctx.font="16px Arial";
    if(isMobile){
      ctx.fillText("Tippe zum Neustart", innerWidth/2, innerHeight/2+18);
      const handler=()=>{ removeEventListener('touchstart',handler); resetGame(); startGame(); };
      addEventListener('touchstart', handler, {once:true, passive:true});
    } else {
      ctx.fillText("Leertaste für Neustart • ESC/Verlassen zur Lobby", innerWidth/2, innerHeight/2+22);
      const keyHandler=(e)=>{ if(e.code==='Space'){ removeEventListener('keydown',keyHandler); resetGame(); startGame(); } };
      addEventListener('keydown', keyHandler, {once:true});
    }
  }

  // ======= Skins initial zeichnen =======
  function renderSkinChoices(){
    skinList.innerHTML='';
    const data = [
      {id:'aqua',name:'Aqua'},{id:'red',name:'Red'},{id:'purple',name:'Purple'},{id:'gold',name:'Gold'},{id:'mint',name:'Mint'}
    ];
    for(const s of data){
      const el = document.createElement('div');
      const locked = !(INV.ownedSkins||{})[s.id];
      el.className = `skin ${s.id} ${s.id===currentSkinId?'active':''} ${locked?'locked':''}`;
      el.title = s.name;
      el.innerHTML = '<div class="dot"></div>';
      el.addEventListener('click', ()=>{
        if(locked) return alert('Skin ist gesperrt. Im Shop freischalten.');
        currentSkinId = s.id; localStorage.setItem(SKIN_KEY,currentSkinId);
        [...skinList.children].forEach(c=>c.classList.remove('active'));
        el.classList.add('active');
      });
      skinList.appendChild(el);
    }
  }
  renderSkinChoices();

  // ======= Self-tests (Konsole) =======
  (function runTests(){
    const t=(name,fn)=>{ try{ fn(); console.log('✅', name);}catch(e){ console.error('❌', name, e);} };

    t('Lobby zuerst sichtbar', ()=>{
      if(getComputedStyle(menu).display==='none') throw new Error('Menu sollte sichtbar sein');
      if(getComputedStyle(modePicker).display!=='none') throw new Error('ModePicker sollte versteckt sein');
    });
    t('ModePicker über Lobby', ()=>{
      btnPlay.click();
      if(getComputedStyle(modePicker).display==='none') throw new Error('ModePicker nicht sichtbar');
      const ziPicker = parseInt(getComputedStyle(modePicker).zIndex||'0',10);
      const ziMenu   = parseInt(getComputedStyle(menu).zIndex||'0',10);
      if(!(ziPicker>ziMenu)) throw new Error('z-index falsch');
      modeCancelBtn.click();
    });
    t('Online: keine KI-Spawns', ()=>{
      const prev=GAME_MODE; GAME_MODE='ONLINE'; resetGame();
      if(S.enemies.length!==0) throw new Error('Online sollte 0 Gegner haben');
      const before = S.enemies.length; S.spawnT=0; for(let i=0;i<10;i++) spawnEnemy();
      if(S.enemies.length!==before) throw new Error('spawnEnemy sollte in Online nichts tun');
      GAME_MODE=prev;
    });
    t('Leave-Button blendet in Lobby zurück', ()=>{
      const prev=GAME_MODE; GAME_MODE='OFFLINE'; startFromLobby();
      btnLeave.click();
      if(getComputedStyle(menu).display==='none') throw new Error('Menu sollte sichtbar sein');
      GAME_MODE=prev;
    });
    console.log('✅ Neo‑Cartoon‑Glass Style aktiv');
  })();

  // Expose for debug
  window._INV = ()=>JSON.parse(localStorage.getItem(INV_KEY)||'{}');

})();
</script>
</body>
</html>
